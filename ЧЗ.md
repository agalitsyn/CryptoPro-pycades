# Пример интеграции с системой Честный Знак (TRUE API) для PHP проектов

В данном репозитории будут выкладываться примеры кода для интеграции с внезаптно свалившейся на наши (Kily Labs) головы системой Честный Знак.

## Общий алгоритм для интеграции

1. Купить УКЭП (Усиленная квалифицированная электронная подпись) ~3000 руб. или сделать тестовую
2. Установить КриптоПРО 5.0 для Linux и купить лицензию ([заказать можно здесь](https://www.cryptopro.ru/order/?online=true)) ~3000 руб.
3. Установить расширение браузера [CryptoPro Extension](https://chrome.google.com/webstore/detail/cryptopro-extension-for-c/iifchhfnnmpdbibifmljnfjhpififfog?hl=ru)
4. Установить расширение pycades
5. Зарегистрироваться в системе [Честный Знак](https://xn--80ajghhoc2aj1c8b.xn--p1ai/)
6. Использовать пример кода из файла этого репозитория

## Стенды

TEST
https://suz.sandbox.crptech.ru
https://api.sb.mdlp.crpt.ru
https://markirovka.sandbox.crptech.ru/api/v3/true-api

PROD
https://suzgrid.crpt.ru
https://api.mdlp.crpt.ru
https://markirovka.crpt.ru/api/v3/true-api

Примечание: Обращение к методам API СУЗ-Облако рекомендуется выполнять не
чаще, чем 10 раз в секунду с одного «IP и omsId» (источника). При превышении
интенсивности вызова методов чаще чем 100 раз в секунду, возможна временная
блокировка источника.

## Авторизация через TRUE API

1. Запрос авторизации при единой аутентификации

    ```
    curl -sSLi \
        -H 'Accept: application/json' \
        -H 'Content-Type: application/json' \
        https://markirovka.sandbox.crptech.ru/api/v3/true-api/auth/key

    {"uuid":"a86c6d5c-3820-4ad6-8e3f-92b819273d49","data":"CZHIEIMAVRQTYQEYCYTDBLSMPVFVQF"}
    ```
2. Подписать `data`
Для создания открепленной подписи необходимо:
    1. Сформировать два файла in.txt и out.txt.
    2. Выбрать подпись
        ```
        /opt/cprocsp/bin/certmgr -list
        ```
        Записать значение поля `SHA1 Thumbprint`
    3. Выполнить в командной строке:
        ```
        /opt/cprocsp/bin/csptest -sfsign -sign -detached -in in.txt -out out.txt -my (указать отпечаток сертификата) -base64 -add
        ```
        Для создания прикрепленной подписи необходимо убрать флаг `-detached`
    4. Далее открыть файл out.txt.
    5. В полученной последовательности символов заменить символы переноса строк (`\r\n`) на пустые значения
        ```
        tr -d "\n\r" < out.txt
        ```
3. Выполнить API запрос, вставив открепленную подпись в соответствующее поле.

    ```
    curl -sSLi \
        -X POST \
        -H 'Accept: application/json' \
        -H 'Content-Type: application/json' \
        --data-raw '{"uuid":"3f8bd0e4-795b-41ab-b892-00199a674c47","data":"MIIMYAYJKoZIhvcNAQcCoIIMUTCCDE0CAQExDDAKBggqhQ=="}' \
        https://markirovka.sandbox.crptech.ru/api/v3/true-api/simpleSignIn/6d0a68f2-8456-4db2-aeab-43e44ea857e1
    ```
